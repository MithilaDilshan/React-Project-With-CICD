name: Full CI Pipeline (Parallel)

on:
  push:
  pull_request:

jobs:
  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install backend deps
        run: |
          cd BACKEND
          npm install

      - name: Backend build
        run: |
          cd BACKEND
          npm run build --if-present

  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install frontend deps
        run: |
          cd frontend
          npm install

      - name: Frontend build
        run: |
          cd frontend
          npm run builds
  

  cypress:
    name: Cypress E2E (${{ matrix.group }})
    runs-on: ubuntu-latest
    needs: [backend, frontend]

    strategy:
      fail-fast: false
      matrix:
        group:
          - Auth
          - UI
          - Dashboard

    env:
      PORT: 8070
      MONGODB_URL: ${{ secrets.MONGODB_URL }}_${{ matrix.group }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_EXPIRE: ${{ secrets.JWT_EXPIRE }}
      NODE_ENV: test

    steps:
      - uses: actions/checkout@v4

      - name: Install backend deps
        run: cd BACKEND && npm install

      - name: Install frontend deps
        run: cd frontend && npm install

      - name: Start backend
        run: |
          cd BACKEND
          npm start > backend.log 2>&1 &

      - name: Wait for backend
        run: npx wait-on http://localhost:8070/health --timeout 180000

      - name: Seed test user
        run: cd BACKEND && npm run seed:test

      - name: Build frontend
        run: cd frontend && REACT_APP_API_URL=http://localhost:8070 npm run build

      - name: Start frontend
        run: | 
          cd frontend
          npx serve -s build -l 3000 --single > frontend.log 2>&1 &
          echo $! > frontend.pid

      - name: Wait for frontend
        run: npx wait-on http://localhost:3000 --timeout 180000

      - name: Clean Cypress coverage
        run: |
          rm -rf coverage lcov-report .nyc_output

      - name: Run Cypress (${{ matrix.group }})
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          install: false
          spec: cypress/e2e/${{ matrix.group }}/*.cy.js
        env:
          CYPRESS_BASE_URL: http://localhost:3000
          CYPRESS_API_URL: http://localhost:8070

      - name: Run frontend tests with coverage
        run: |
          cd frontend
          rm -rf coverage
          npm run test:coverage

      - name: Upload Cypress coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-coverage
          path: |
            coverage
            coverage/lcov-report


      - name: Upload Cypress videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos

      - name: Upload Cypress screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots    

      - name: Show backend logs (after Cypress)
        if: always()
        run: |
          echo "=== BACKEND LOGS ==="          
          cat backend.log || echo "No backend logs found"          
          echo "=== FRONTEND LOGS ==="          
          cat frontend.log || echo "No frontend logs found"
      
      - name: Cleanup processes        
        if: always()        
        run: |          
          if [ -f backend.pid ]; then kill $(cat backend.pid) 2>/dev/null || true; fi          
          if [ -f frontend.pid ]; then kill $(cat frontend.pid) 2>/dev/null || true; fi

